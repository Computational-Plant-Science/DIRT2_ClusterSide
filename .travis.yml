os: linux
dist: bionic

services:
  - docker

language: go

go:
  - "1.13"

python:
  - "3.6"

addons:
  apt:
    packages:
      - flawfinder
      - squashfs-tools
      - uuid-dev
      - libuuid1
      - libffi-dev
      - libssl-dev
      - libssl1.0.0
      - libarchive-dev
      - libgpgme11-dev
      - libseccomp-dev
      - python3-pip
  homebrew:
    packages:
      - squashfs
    update: true

sudo: required

before_install:
  - docker pull mjstealey/irods-provider-postgres:4.2.3
  - docker run -d -p 1247:1247 -p 5432:5432 mjstealey/irods-provider-postgres:4.2.3
  - sudo apt-get install python3-setuptools
  - sudo apt-get install libfuse2
  - sudo wget https://files.renci.org/pub/irods/releases/4.1.12/ubuntu14/irods-icommands-4.1.12-ubuntu14-x86_64.deb
  - sudo dpkg -i irods-icommands-4.1.12-ubuntu14-x86_64.deb
  - sudo rm irods-icommands-4.1.12-ubuntu14-x86_64.deb
  - sudo chmod +x wait-for-postgres.sh
  - sudo chmod +x wait-for-it.sh
  - sudo chmod +x configure-irods.sh
  - sudo chmod +x integration_tests.sh
  - ./wait-for-postgres.sh localhost
  - sleep 2
  - printf 'localhost\n1247\nrods\ntempZone\nrods\n' | iinit
  - iput tests/sample1.jpg
  - iput tests/sample2.jpg
  - iput tests/sample3.jpg
  - >
    export VERSION=3.5.2 &&
    wget https://github.com/sylabs/singularity/releases/download/v${VERSION}/singularity-${VERSION}.tar.gz &&
    tar -xzf singularity-${VERSION}.tar.gz &&
    cd singularity
  - >
    ./mconfig &&
    make -C builddir &&
    sudo make -C builddir install &&
    cd ..

install:
  - pip3 --version
  - python3 --version
  - sudo pip3 install -e .
  - sudo pip3 install -U pytest

script:
  - python3 -m pytest
  - ./integration_tests.sh
